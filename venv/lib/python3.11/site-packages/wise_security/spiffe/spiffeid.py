from .trust_domain import TrustDomain

_SPIFFE_PROTOCOL = 'spiffe://'


class SpiffeID:
    def __init__(self, service: str, trust_domain: TrustDomain):
        """
        Create Spiffe instance from service name and trust domain
        Args:
            service: service name
            trust_domain: instance of TrustDomain
        """
        if not service:
            raise ValueError('Service cannot be empty in Spiffe ID!')

        if not trust_domain:
            raise ValueError('Trust domain cannot be null in Spiffe ID!')

        self._trust_domain: TrustDomain = trust_domain
        self._service: str = service

    @classmethod
    def from_id(cls, spiffe_id: str) -> 'SpiffeID':
        """
        Construct Spiffe instance from the given ID
        Args:
            spiffe_id: spiffe id in its string format,
                example: spiffe://main.production.transferwise.spire/service-x

        Returns: Instance of SpiffeID
        """
        if not spiffe_id:
            raise ValueError('Empty Spiffe ID provided!')

        if not spiffe_id.startswith(_SPIFFE_PROTOCOL):
            raise ValueError(f'Invalid Spiffe ID "{spiffe_id}"!')

        spiffe_parts = spiffe_id[len(_SPIFFE_PROTOCOL) :].split('/')

        return cls(spiffe_parts[1], TrustDomain.from_str(spiffe_parts[0]))

    @property
    def trust_domain(self) -> str:
        return str(self._trust_domain)

    @property
    def service(self) -> str:
        return self._service

    def __str__(self) -> str:
        """
        Spiffe ID as string
        """
        return f'{_SPIFFE_PROTOCOL}{self._trust_domain}/{self._service}'

    def __eq__(self, other) -> bool:
        """
        Checks if given object is equal to self, equality requires the other object to be of SpiffeId type and has same
        string representation as self

        Args:
            other: an object

        Returns: True if self and object are equal, False otherwise
        Raises: NotImplementedError if object is not of type SpiffeID
        """
        if isinstance(other, SpiffeID):
            return str(self) == str(other)

        raise NotImplementedError(f'Cannot compare object of type {type(other)} to a SpiffeID object!')
