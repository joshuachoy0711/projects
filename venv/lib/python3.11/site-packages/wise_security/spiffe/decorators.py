from dataclasses import dataclass
from functools import wraps
from typing import Callable, List, Optional

from ..ws_typing import AuthorizedService
from .logger import logger
from .validators import validate_spiffe

DEFAULT_SPIFFE_ID_HEADER = 'x-tw-envoy-spiffe-id'


@dataclass
class RequestMetadata:
    url: Optional[str]
    spiffe_id: Optional[str]
    remote_addr: Optional[str]


def for_services(
    authorized_services: List[AuthorizedService],
    get_request: Callable[[], RequestMetadata],
):
    """
    A decorator that checks if the incoming request is from an authorized service and non-loopback address
    """

    def decorator(function):
        @wraps(function)
        def wrapper(*args, **kwargs):
            request = get_request()
            url = request.url
            spiffe_id = request.spiffe_id
            remote_addr = request.remote_addr
            logger.info(f'Running spiffe checks on endpoint {url}')
            validate_spiffe(spiffe_id, authorized_services, remote_addr)

            return function(*args, **kwargs)

        return wrapper

    return decorator
