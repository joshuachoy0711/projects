from itertools import filterfalse


class TrustDomain:
    _SUFFIX = '.transferwise.spire'

    def __init__(self, internal_trust_domain: str, environment: str):
        """
        Instantiate a trust domain from a given internal domain and environment
        """
        if not internal_trust_domain:
            raise ValueError('Internal trust domain cannot be empty!')

        if not environment:
            raise ValueError('Environment cannot be empty!')

        self._internal_trust_domain: str = internal_trust_domain
        self._environment: str = environment

    @classmethod
    def from_str(cls, trust_domain: str) -> 'TrustDomain':
        """
        Create instance of TrustDomain given a string of the format:
        {cluster}.{environment}.transferwise.spire
        Args:
            trust_domain: trust domain as string
        Returns: TrustDomain instance
        """
        if not trust_domain:
            raise ValueError('Cannot parse empty trust domain!')

        if not trust_domain.endswith(cls._SUFFIX):
            raise ValueError(f'Invalid trust domain "{trust_domain}"! It does not end with "transferwise.spire"')

        trust_domain_parts = trust_domain.split('.')

        if len(trust_domain_parts) != 4:
            raise ValueError(f'Invalid trust domain "{trust_domain}"! Unexpected format')

        # check if all substrings are not empty/null
        if list(filterfalse(None, trust_domain_parts)):
            raise ValueError(f'Badly formatted trust domain "{trust_domain}"!')

        return cls(trust_domain_parts[0], trust_domain_parts[1])

    @property
    def internal_trust_domain(self) -> str:
        return self._internal_trust_domain

    @property
    def environment(self) -> str:
        return self._environment

    def __str__(self) -> str:
        return f'{self._internal_trust_domain}.{self._environment}{self._SUFFIX}'
