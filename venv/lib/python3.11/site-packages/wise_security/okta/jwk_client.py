import logging
import re
import time
from typing import List, Optional

import requests
from jwt import PyJWK, PyJWKClientConnectionError, PyJWKClientError, PyJWKSet
from jwt.api_jwt import decode_complete as decode_token
from requests.structures import CaseInsensitiveDict


class JWKClient:
    """A custom client for fetching and caching of JWK sets from Okta. This class uses
    functions and classes from `pyjwt` but does not use the  `PyJWKClient` directly.
    The main differences between this class and `PyJWKClient` are:

    - We handle fetching and caching of the JWKS URI.
    - We use the `cache-control` directive to determine how long to cache the JWKS URI
      and JWK set, as per https://developer.okta.com/docs/concepts/key-rotation/"""

    def __init__(
        self,
        issuer_url: str,
        default_jwks_uri_max_age: int = 3600 * 24,
        default_jwks_max_age: int = 300,
    ) -> None:
        """Initialize the JWK client.

        Parameters
        ----------
        issuer_url : str
            The issuer URL of the Okta Authorization Server.
            Usually `https://transferwise.okta-emea.com`

        default_jwks_uri_max_age : int, optional
            The default time in seconds to fallback to if the `max-age` is not present in
            the `cache-control` headers, by default 3600 * 24

        default_jwks_max_age : int, optional
            The default time in seconds to fallback to if the `max-age` is not present in
            the `cache-control` headers, by default 300
        """
        self.issuer_url = issuer_url
        self.default_jwks_uri_max_age = default_jwks_uri_max_age
        self.default_jwks_max_age = default_jwks_max_age

        self.jwk_set: Optional[PyJWKSet] = None
        self.jwks_uri: Optional[str] = None
        self.logger = logging.getLogger(__name__)

        self.jwks_uri_expires_at = 0
        self.jwks_expires_at = 0

    @staticmethod
    def _get_max_age_or_default(
        uri: str,
        headers: CaseInsensitiveDict,
        default: int,
    ) -> int:
        max_age = None

        if 'cache-control' in headers:
            cache_control = headers['cache-control']

            if 'no-cache' in cache_control:
                max_age = 0
            else:
                match = re.search(r'max-age=(\d+)', cache_control)

                if match:
                    max_age = int(match.group(1))

        if max_age is None:
            logging.warning(f'Unable to parse max-age for {uri}. Defaulting to {default}')
            max_age = default

        return max_age

    @staticmethod
    def _match_kid(signing_keys: List[PyJWK], kid: str) -> Optional[PyJWK]:
        return next((key for key in signing_keys if key.key_id == kid), None)

    def fetch_jwks_uri(self) -> str:
        discovery_url = f'{self.issuer_url}/.well-known/openid-configuration'

        try:
            response = requests.get(discovery_url)
            response.raise_for_status()

        except requests.exceptions.RequestException:
            raise PyJWKClientConnectionError('Unable to fetch discovery document')

        max_age = self._get_max_age_or_default(
            discovery_url,
            response.headers,
            self.default_jwks_uri_max_age,
        )
        self.jwks_uri_expires_at = int(time.time()) + max_age
        discovery_data = response.json()
        return str(discovery_data['jwks_uri'])

    def fetch_jwk_set(self, refresh_jwks_uri: bool = False) -> PyJWKSet:
        if refresh_jwks_uri or not self.jwks_uri or self.jwks_uri_expires_at < time.time():
            self.jwks_uri = self.fetch_jwks_uri()

        try:
            response = requests.get(self.jwks_uri)
            response.raise_for_status()

        except requests.exceptions.RequestException:
            raise PyJWKClientConnectionError('Unable to fetch JWKS URL')

        max_age = self._get_max_age_or_default(
            self.jwks_uri,
            response.headers,
            self.default_jwks_max_age,
        )
        self.jwks_expires_at = int(time.time()) + max_age
        json = response.json()
        return PyJWKSet.from_dict(json)

    def get_signing_keys(self, refresh: bool = False) -> List[PyJWK]:
        if refresh or not self.jwk_set or self.jwks_expires_at < time.time():
            self.jwk_set = self.fetch_jwk_set(refresh_jwks_uri=refresh)

        signing_keys = [
            jwk_set_key
            for jwk_set_key in self.jwk_set.keys
            if jwk_set_key.public_key_use in ['sig', None] and jwk_set_key.key_id
        ]

        if not signing_keys:
            raise PyJWKClientError('The JWKS endpoint did not contain any signing keys')

        return signing_keys

    def get_signing_key(self, kid: str) -> PyJWK:
        signing_keys = self.get_signing_keys()
        signing_key = self._match_kid(signing_keys, kid)

        if not signing_key:
            # If no matching signing key from the jwk set, refresh the jwk set and try again.
            signing_keys = self.get_signing_keys(refresh=True)
            signing_key = self._match_kid(signing_keys, kid)

            if not signing_key:
                raise PyJWKClientError(f'Unable to find a signing key that matches: "{kid}"')

        return signing_key

    def get_signing_key_from_jwt(self, token: str) -> PyJWK:
        unverified = decode_token(token, options={'verify_signature': False})
        header = unverified['header']
        return self.get_signing_key(header.get('kid'))
