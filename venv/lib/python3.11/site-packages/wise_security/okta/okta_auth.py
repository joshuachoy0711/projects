import logging
from functools import wraps
from typing import Callable, Dict, List, Optional

import jwt

from wise_security.errors import Unauthorized
from wise_security.okta.jwk_client import JWKClient


class OktaAuth:
    def __init__(
        self,
        issuer_url: str,
        audience: str,
        algorithms: List[str],
        default_jwks_uri_max_age: int = 3600 * 24,
        default_jwks_max_age: int = 300,
    ) -> None:
        """Decorator which is  used to validated Okta JWT tokens. This class should be
        instantiated once and then used as a decorator on the methods that need to be
        protected. Example usage:

        ```python
        from flask import Flask
        from wise_security.okta.okta_auth import OktaAuth

        app = Flask(__name__)
        okta_auth = OktaAuth(...)

        @app.route("/", methods=["GET"])
        @okta_auth
        def example_get(email: str):
            return {"message": f"Hello, {email}"}
        ```

        Parameters
        ----------
        issuer_url : str
            The issuer URL of the Okta Authorization Server.
            Usually `https://transferwise.okta-emea.com`

        audience : str
            The audience to validate the token against. Usually the client ID of the
            application.

        algorithms : list[str]
            The algorithms that should be used to validate the token. Usually `["RS256"]`

        default_jwks_uri_max_age : int
            The default time in seconds to cache the JWKS URI if the `max-age` is not
            present in the `cache-control` headers. Default is 24 hours.

        default_jwks_max_age : int
            The default time in seconds to cache the JWKS if the `max-age` is not present
            in the `cache-control` headers. Default is 5 minutes.
        """
        self.audience = audience
        self.algorithms = algorithms
        self.jwk_client = JWKClient(
            issuer_url,
            default_jwks_uri_max_age,
            default_jwks_max_age,
        )

    def validate_token(self, token: str) -> str:
        try:
            signing_key = self.jwk_client.get_signing_key_from_jwt(token)

        except jwt.PyJWKClientError as e:
            logging.warning(f'Error when getting signing key from JWT. Error: {e}')
            raise Unauthorized('Error when getting signing key from JWT')

        except jwt.PyJWKSetError as e:
            logging.warning(f'Error when getting JWKS. Error: {e}')
            raise Unauthorized('Error when getting JWKS')

        except jwt.DecodeError:
            raise Unauthorized('Malformed token')

        try:
            data = jwt.decode(
                token,
                signing_key.key,
                algorithms=self.algorithms,
                audience=self.audience,
                options={'verify_exp': True},
            )

        except jwt.ExpiredSignatureError:
            raise Unauthorized('Token has expired')

        email = data.get('email')

        if not email:
            raise Unauthorized('Invalid token: email is missing')

        return str(email)

    def __call__(self, get_headers: Callable[[], Dict[str, Optional[str]]]):
        def decorator(func):
            @wraps(func)
            def decorated_function(*args, **kwargs):
                headers = get_headers()
                token = None

                if 'Authorization' in headers:
                    auth_header = headers['Authorization']
                    token = auth_header.replace('Bearer ', '')

                if not token:
                    raise Unauthorized('Token is missing')

                email = self.validate_token(token)

                return func(email, *args, **kwargs)

            return decorated_function

        return decorator
