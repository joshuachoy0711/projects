import uuid
from threading import Lock
from typing import Any, ClassVar, List

import boto3
import requests
from cachetools import TTLCache, cached
from pydantic import BaseModel, ConfigDict, Field, model_validator

from wise_security.errors import UnauthorizedSTSRequest
from wise_security.sts.validators import parse_pre_signed_url, validate_sts_url

MINUTE = 60
EXPIRY = 15 * MINUTE


class STSAuth(BaseModel):
    _model_config = ConfigDict(extra='forbid')
    region: str = Field(description='The region in which the AWS STS service is running.')

    # The boto3 client for STS. Set as a class variable to avoid creating multiple clients.
    # Used Any to avoid adding types-boto3 and other stubs as production dependencies.
    _client: ClassVar[Any] = None

    def __hash__(self) -> int:
        return uuid.uuid4().int

    @model_validator(mode='after')
    def setup_sts_client(self) -> Any:
        """
        This method initializes the boto3 client for STS. It is called after the model is validated.
        """
        STSAuth._client = boto3.client(
            'sts', endpoint_url=f'https://sts.{self.region}.amazonaws.com/', region_name=self.region
        )
        return self

    @cached(cache=TTLCache(maxsize=1, ttl=EXPIRY), lock=Lock())
    def generate_token(self) -> str:
        """
        This method generates a presigned URL for a client using AWS STS for authentication.
        The generated URL should be used with header `x-aws-presigned-url` to authenticate the request on a service.

        Returns:
            str: A presigned URL that can be used to authenticate a request.
        """
        url: str = STSAuth._client.generate_presigned_url(
            ClientMethod='get_caller_identity',
            ExpiresIn=EXPIRY,
            HttpMethod='POST',
        )
        return url

    def validate_token(self, token: str, approved_roles: List[str]) -> str:
        """
        This method validates the token generated by `generate_token` with client_method = 'get_caller_identity'.

        A valid pre-signed URL will return a response similar to the following:
        ```
        <GetCallerIdentityResponse xmlns="https://sts.amazonaws.com/doc/2011-06-15/">
            <GetCallerIdentityResult>
                <Arn>arn:aws:sts::{account}:assumed-role/{iam-role-name}/{service}</Arn>
                <UserId>{USER_ID}:{service}</UserId>
                <Account>{ACCOUNT_ID}</Account>
            </GetCallerIdentityResult>
            <ResponseMetadata>...</ResponseMetadata>
        </GetCallerIdentityResponse>
        ```

        Args:
            token (str): The token generated by `generate_token` method.
            approved_roles (List[str]): A list of role ARNs that should be authorized to access the service.

        Returns:
            str: The role ARN from the XML response present in the approved_roles list.
        """
        validate_sts_url(token)
        response = requests.post(token)
        if response.status_code != 200:
            raise UnauthorizedSTSRequest(f'Request failed because: {response.text}')

        role_arn = parse_pre_signed_url(response.text, approved_roles)
        return role_arn
