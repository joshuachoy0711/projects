import re
from typing import ClassVar, Optional

from pydantic import BaseModel

from wise_security.errors import UnauthorizedSTSRequest


class AWSRole(BaseModel):
    """
    A Pydantic model for the role ARN.
    """

    account_id: str
    resource: str
    name: str
    session_id: Optional[str] = None
    _prefix: ClassVar[str] = 'arn:aws:sts::'
    _pattern: ClassVar[re.Pattern] = re.compile(
        r'arn:aws:(sts|iam)::(?P<account_id>\d{12}):(?P<resource>assumed-role|role)'
        r'\/(?P<name>[a-zA-Z0-9_\-]+)(\/(?P<session_id>[a-zA-Z0-9_\-]+))?'
    )

    @classmethod
    def from_arn(cls, arn: str) -> 'AWSRole':
        """
        Create a Role object from a role ARN.

        Example
        -------
        role_arn = 'arn:aws:sts::123456789012:assumed-role/role-name/session-name'

        Args:
            arn (str): The role ARN to parse.

        Returns:
            Role: A Role object with the parsed ARN.
        """
        match: Optional[re.Match] = re.match(cls._pattern, arn)
        if not match:
            raise UnauthorizedSTSRequest(f'Invalid role ARN: {arn}')

        groups = match.groupdict()
        return cls(**groups)

    def __hash__(self) -> int:
        return hash((self.account_id, self.name))

    def __eq__(self, value: object) -> bool:
        if not isinstance(value, AWSRole):
            return False
        name_matches = self.name == value.name
        account_matches = self.account_id == value.account_id
        return account_matches and name_matches
