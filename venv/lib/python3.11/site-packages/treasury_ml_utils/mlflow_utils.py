
from typing import Any, List
from datetime import datetime
import os
import threading
import time

import mlflow
from mlflow.entities import Run
from mlflow.tracking.client import MlflowClient

from treasury_ml_utils.sts.client import STSAuth


def authorize_mlflow(interval: int = 600, region: str = 'eu-central-1'):
    """
    Authorize MLflow using STS tokens. Refresh every `interval` seconds, as STS tokens expire rather frequently by
    design.
    """

    def _loop():
        while True:
            try:
                sts_auth = STSAuth(region=region)
                os.environ['MLFLOW_TRACKING_TOKEN'] = sts_auth.generate_token()
            except Exception as exception:
                print(f'Error when refreshing MLflow token: {exception}')
            time.sleep(interval)

    sts_auth = STSAuth(region=region)
    os.environ['MLFLOW_TRACKING_TOKEN'] = sts_auth.generate_token()
    _mlflow_authorize_thread = threading.Thread(target=_loop, daemon=True)
    _mlflow_authorize_thread.start()


def get_latest_experiment_mlflow(mlflow_tracking_uri: str, experiment_name: str, model_name: str) -> Run:
    """
    Get latest experiment from Mlflow based on the experiment name and model type.
    """
    authorize_mlflow()
    mlflow.set_tracking_uri(mlflow_tracking_uri)

    experiment = mlflow.get_experiment_by_name(experiment_name)
    runs = MlflowClient().search_runs(experiment_ids=[experiment.experiment_id])
    runs = [run for run in runs if model_name == run.info.run_name]

    runs.sort(key=lambda x: datetime.utcfromtimestamp(int(x.info.start_time / 1000)), reverse=True)
    return runs[0]


def get_model_run_id_dict(mlflow_tracking_uri: str, experiment_name: str, model_names: List[str]) -> dict:
    """
    Create a dictionary with model names as keys and run ids as values for the latest runs in the experiment.
    """
    run_id_dict = {}
    for model_name in model_names:
        run = get_latest_experiment_mlflow(mlflow_tracking_uri, experiment_name, model_name)
        run_id_dict[model_name] = run.info.run_id

    return run_id_dict


def get_experiment_id(mlflow_tracking_uri: str, experiment_name: str) -> Any:
    """
    Get experiment ID from Mlflow based on the experiment name.
    """
    authorize_mlflow()
    mlflow.set_tracking_uri(mlflow_tracking_uri)

    experiment = mlflow.get_experiment_by_name(experiment_name)
    return experiment.experiment_id
