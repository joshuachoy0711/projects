from typing import Any, ClassVar, List, Union
from threading import Lock
import uuid

import boto3
from cachetools import cached, TTLCache
import requests

from treasury_ml_utils.sts.sts_errors import UnauthorizedSTSRequest
from treasury_ml_utils.sts.validators import parse_pre_signed_url, validate_sts_url

MINUTE = 60
EXPIRY = 15 * MINUTE


class STSAuth:
    _client: ClassVar[Any] = None

    def __init__(self, region: str):
        self.region = region
        self._validate_fields()
        self.setup_sts_client()

    def _validate_fields(self):
        if not isinstance(self.region, str):
            raise ValueError("The 'region' must be a string.")

    def __hash__(self) -> int:
        return uuid.uuid4().int

    def setup_sts_client(self) -> None:
        """
        This method initializes the boto3 client for STS.
        """
        STSAuth._client = boto3.client(
            'sts', endpoint_url=f'https://sts.{self.region}.amazonaws.com/', region_name=self.region
        )

    @cached(cache=TTLCache(maxsize=1, ttl=EXPIRY), lock=Lock())
    def generate_token(self) -> str:
        """
        This method generates a presigned URL for a client using AWS STS for authentication.
        The generated URL should be used with header `x-aws-presigned-url` to authenticate the request on a service.

        Returns:
            str: A presigned URL that can be used to authenticate a request.
        """
        url: str = STSAuth._client.generate_presigned_url(
            ClientMethod='get_caller_identity',
            ExpiresIn=EXPIRY,
            HttpMethod='POST',
        )
        return url

    def validate_token(self, token: str, approved_roles: List[str]) -> Union[str, Any]:
        """
        This method validates the token generated by `generate_token` with client_method = 'get_caller_identity'.

        A valid pre-signed URL will return a response similar to the following:
        ```
        <GetCallerIdentityResponse xmlns="https://sts.amazonaws.com/doc/2011-06-15/">
            <GetCallerIdentityResult>
                <Arn>arn:aws:sts::{account}:assumed-role/{iam-role-name}/{service}</Arn>
                <UserId>{USER_ID}:{service}</UserId>
                <Account>{ACCOUNT_ID}</Account>
            </GetCallerIdentityResult>
            <ResponseMetadata>...</ResponseMetadata>
        </GetCallerIdentityResponse>
        ```

        Args:
            token (str): The token generated by `generate_token` method.
            approved_roles (List[str]): A list of role ARNs that should be authorized to access the service.

        Returns:
            str: The role ARN from the XML response present in the approved_roles list.
        """
        validate_sts_url(token)
        response = requests.post(token)
        if response.status_code != 200:
            raise UnauthorizedSTSRequest(f'Request failed because: {response.text}')

        role_arn = parse_pre_signed_url(response.text, approved_roles)
        return role_arn
