from typing import List
import re
from urllib import parse
from xml.etree import ElementTree

from treasury_ml_utils.sts.role import AWSRole
from treasury_ml_utils.sts.sts_errors import UnauthorizedSTSRequest

# Regex pattern to match the STS endpoint URL (only the netlock).
# The default url is https://sts.amazonaws.com but there can be instances where the region is specified.
STS_ENDPOINT_PATTERN = re.compile(r'sts(\.[a-z1-9\-]+)?\.amazonaws.com\/?')


def validate_sts_url(url: str) -> None:
    """
    Validate the STS URL provided by the user.

    Args:
        url (str): The STS URL provided by the user.

    Raises:
        UnauthorizedSTSRequest: The URL provided is not a valid STS endpoint.
    """
    parts = parse.urlparse(url)
    invalid_scheme = parts.scheme != 'https'
    invalid_netloc = not STS_ENDPOINT_PATTERN.match(parts.netloc)
    if invalid_scheme or invalid_netloc:
        raise UnauthorizedSTSRequest('Invalid STS URL provided.')


def parse_pre_signed_url(xml: str, allowlist: List[str]) -> str:
    """
    Parse the response from a pre-signed URL POST request and return the role ARN.

    This function uses an XPath query to find the role ARN within a namespace that looks like:
    "https://sts.amazonaws.com/doc/VERSION/"

    Args:
        xml (str): The XML response from the pre-signed URL POST request.
        approved_roles (List[str]): A list of role ARNs that should be authorized to access the service.

    Raises:
        UnauthorizedSTSRequest: The role ARN is not in the approved_roles list.
        UnauthorizedSTSRequest: The response does not contain a role ARN.

    Returns:
        str: The role ARN from the XML response present in the approved_roles list.
    """

    role_arn = get_role_arn_from_pre_signed_url(xml)
    role = AWSRole.from_arn(role_arn)

    allowed_roles = set(AWSRole.from_arn(role) for role in allowlist)
    if role not in allowed_roles:
        raise UnauthorizedSTSRequest(f'Role {role_arn} not authorized to access this service.')
    return role_arn


def get_role_arn_from_pre_signed_url(xml: str) -> str:
    """
    Extract the role ARN from the XML response of a pre-signed URL request.

    Process the XML response to extract the role ARN from the <Arn> tag within the namespace.
    Raise an exception if the role ARN is not found or the response is invalid.

    Args:
        xml (str): The XML response from the pre-signed URL POST request.

    Raises:
        UnauthorizedSTSRequest: Raised if the XML does not contain a valid <Arn> tag or the <Arn> value is missing.

    Returns:
        str: The role ARN extracted from the XML response.
    """

    tree = ElementTree.fromstring(xml)
    # When processing the expected XML, we receive a namespace that looks like:
    # <GetCallerIdentityResponse xmlns="https://sts.amazonaws.com/doc/2011-06-15/"> ...
    # The tree.tag value is {https://sts.amazonaws.com/doc/2011-06-15/}GetCallerIdentityResponse

    namespace = {'ns': tree.tag.split('}')[0].strip('{')}
    search_result = tree.find('.//ns:Arn', namespace)
    if search_result is None:
        raise UnauthorizedSTSRequest('Pre-signed URL did not return a role.')
    role_arn = search_result.text
    if not role_arn:
        raise UnauthorizedSTSRequest('Pre-signed URL did not return a role.')
    return role_arn
