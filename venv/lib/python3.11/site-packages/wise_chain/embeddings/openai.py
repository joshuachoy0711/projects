from typing import Dict, List

from wise_chain.embeddings.gateway_wrapper import GatewayEmbeddingsWrapper
from wise_chain.llm_registry import LLMRegistry
from wise_chain.llms.exceptions import RequestFormattingError, ResponseFormattingError

OPENAI_EMBEDDINGS = [
    'text-embedding-ada-002',
    'text-embedding-3-small',
    'text-embedding-3-large',
]


@LLMRegistry.register(OPENAI_EMBEDDINGS)
class OpenAIEmbeddings(GatewayEmbeddingsWrapper):
    vendor: str = 'credal/openai'
    endpoint: str = 'embeddings'

    def _format_request(self, text: str, **kwargs) -> Dict:
        try:
            return {
                'input': text,
                **kwargs,
            }
        except KeyError as ex:
            raise RequestFormattingError(f'Failed to format request: {ex}') from ex

    def _format_response(self, response: Dict) -> List[float]:
        try:
            return [float(num) for num in response['data'][0]['embedding']]
        except KeyError as ex:
            raise ResponseFormattingError(f'Failed to format request: {ex}') from ex
