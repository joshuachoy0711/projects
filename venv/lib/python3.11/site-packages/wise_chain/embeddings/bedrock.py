from typing import Dict, List

from wise_chain.embeddings.gateway_wrapper import GatewayEmbeddingsWrapper
from wise_chain.llm_registry import LLMRegistry
from wise_chain.llms.exceptions import RequestFormattingError, ResponseFormattingError

BEDROCK_EMBEDDINGS = [
    'amazon.titan-embed-text-v1',
    'amazon.titan-embed-g1-text-02',
]


@LLMRegistry.register(BEDROCK_EMBEDDINGS)
class BedrockEmbeddings(GatewayEmbeddingsWrapper):
    vendor: str = 'bedrock'
    endpoint: str = 'invoke-model'

    def _format_request(self, text: str, **kwargs) -> Dict:
        try:
            return {
                'inputText': text,
                **kwargs,
            }
        except KeyError as ex:
            raise RequestFormattingError(f'Failed to format request: {ex}') from ex

    def _format_response(self, response: Dict) -> List[float]:
        try:
            return [float(num) for num in response['embedding']]
        except KeyError as ex:
            raise ResponseFormattingError(f'Failed to format request: {ex}') from ex
