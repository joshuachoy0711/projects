import json

import requests

from wise_chain.auth.exceptions import DiscoveryError
from wise_chain.auth.provider_config import ProviderConfig


def fetch_provider_config(issuer: str) -> ProviderConfig:
    """Fetch a provider configuration from an OIDC issuer (URL)."""
    if not issuer.startswith('https://'):
        raise DiscoveryError('The issuer URL must be HTTPS.')

    url = f"{issuer.rstrip('/')}/.well-known/openid-configuration"

    try:
        response = requests.get(url)
        response.raise_for_status()

    except requests.exceptions.RequestException as error:
        raise DiscoveryError(f'Error from auth server {error}') from error

    try:
        data = response.json()

    except json.JSONDecodeError as error:
        raise DiscoveryError(f'Error decoding response from auth server {error}') from error

    if data.get('issuer') != issuer:
        raise DiscoveryError('The issuer value returned must be identical to the issuer URL.')

    return ProviderConfig(
        issuer=issuer,
        authorization_endpoint=data['authorization_endpoint'],
        token_endpoint=data['token_endpoint'],
    )
