import datetime
import json
import logging
from pathlib import Path
from typing import Optional

from pydantic import BaseModel


class Credential(BaseModel):
    access_token: Optional[str]
    token_type: Optional[str]
    expires_in: Optional[int]
    expires_at: Optional[int]
    scope: Optional[str]
    id_token: Optional[str]

    def is_expired(self, buffer: int = 2 * 60) -> bool:
        """Check if the auth credentials have expired, optionally including some buffer time.

        Parameters
        ----------
        credentials : Credentials
            The credentials to check for expiration
        buffer : int, optional
            A buffer time to proactively refresh credentials, by default 2*60 (2 minutes)

        Returns
        -------
        bool
            If the credentials have expired
        """
        if not self.expires_at:
            return True

        return self.expires_at < int(datetime.datetime.now().timestamp()) + buffer


class CredentialManager:
    """Manages lifetime of credentials file at `credential_file_path`."""

    def __init__(self, credential_path: Path) -> None:
        self.credential_path = credential_path
        self.logger = logging.getLogger(__name__)

    def delete_credentials(self) -> None:
        """Deletes the credentials file if it exists"""
        if self.credential_path.exists():
            self.logger.debug('Deleting credentials file')
            self.credential_path.unlink()

    def get_credentials(self) -> Credential:
        """Gets the credentials file, creating it if doesn't exist"""
        if not self.credential_path.exists():
            self.logger.debug('No credentials file found, creating new credentials file')
            self.credential_path.parent.mkdir(parents=True, exist_ok=True)
            self.credential_path.write_text('{}')
            return Credential(
                access_token=None,
                token_type=None,
                expires_in=None,
                expires_at=None,
                scope=None,
                id_token=None,
            )

        with self.credential_path.open('r', encoding='utf-8') as file:
            self.logger.debug('Reading credentials file')
            credentials = json.load(file)

        if not credentials:
            return Credential(
                access_token=None,
                token_type=None,
                expires_in=None,
                expires_at=None,
                scope=None,
                id_token=None,
            )

        return Credential(**credentials)

    def save_credentials(self, credentials: Credential) -> None:
        """Saves the credentials file"""
        self.logger.debug('Saving credentials file')
        with self.credential_path.open('w', encoding='utf-8') as file:
            file.write(credentials.model_dump_json(indent=4))
