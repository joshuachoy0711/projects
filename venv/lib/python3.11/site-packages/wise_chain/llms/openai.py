from typing import Dict, List, Optional

from wise_chain.llm_registry import LLMRegistry
from wise_chain.llms.exceptions import ResponseFormattingError
from wise_chain.llms.gateway_wrapper import GatewayLLMWrapper

OPENAI_LLMS = [
    'gpt-3.5-turbo',
    'gpt-4',
    'gpt-4-0125-preview',
    'gpt-4-turbo-preview',
    'gpt-4-turbo',
    'gpt-4o',
    'gpt-4o-mini',
    'gpt-4.1-mini',
    'gpt-4.1-nano',
    'o4-mini',
    'o3',
    'o1-mini',
    'gpt-4o-search-preview',
    'o1',
    'o3-mini',
    'gpt-4o-mini-search-preview',
    'gpt-4-1106-preview',
    'gpt-3.5-turbo-1106',
    'gpt-3.5-turbo-16k',
    'gpt-5',
    'gpt-5-mini',
    'gpt-5-nano',
    'gpt-5.1',
]


@LLMRegistry.register(OPENAI_LLMS)
class OpenAI(GatewayLLMWrapper):
    vendor: str = 'credal/openai'
    endpoint: str = 'chat/completions'

    def _format_request(self, text: str, stop: Optional[List[str]] = None, **kwargs) -> Dict:
        request = {
            'messages': [
                {'role': 'system', 'content': 'You are a helpful assistant.'},
                {'role': 'user', 'content': text},
            ],
            **kwargs,
        }
        if stop:
            request['stop'] = stop
        return request

    def _format_response(self, response: Dict) -> str:
        try:
            return str(response['choices'][0]['message']['content'])

        except Exception as ex:
            raise ResponseFormattingError(f'Failed to format response: {ex}') from ex
