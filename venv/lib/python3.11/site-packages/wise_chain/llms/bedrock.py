from typing import Dict, List, Optional

from wise_chain.llm_registry import LLMRegistry
from wise_chain.llms.exceptions import RequestFormattingError, ResponseFormattingError
from wise_chain.llms.gateway_wrapper import GatewayLLMWrapper

BEDROCK_LLMS = [
    'amazon.titan-tg1-large',
    'amazon.titan-text-express-v1',
]


@LLMRegistry.register(BEDROCK_LLMS)
class Bedrock(GatewayLLMWrapper):
    vendor: str = 'bedrock'
    endpoint: str = 'invoke-model'

    def _format_request(self, text: str, stop: Optional[List[str]] = None, **kwargs) -> Dict:
        try:
            request = {
                'inputText': text,
                'textGenerationConfig': {**kwargs, **({'stopSequences': stop} if stop else {})},
            }
        except Exception as ex:
            raise RequestFormattingError(f'Failed to format request: {ex}') from ex
        return request

    def _format_response(self, response: Dict) -> str:
        try:
            return str(response['results'][0]['outputText'])
        except Exception as ex:
            raise ResponseFormattingError(f'Failed to format response: {ex}') from ex
