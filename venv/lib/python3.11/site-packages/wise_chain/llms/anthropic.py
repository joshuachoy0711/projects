from typing import Dict, List, Optional

from wise_chain.constants import MAX_CLAUDE_OUTPUT_TOKENS
from wise_chain.llm_registry import LLMRegistry
from wise_chain.llms.exceptions import RequestFormattingError, ResponseFormattingError
from wise_chain.llms.gateway_wrapper import GatewayLLMWrapper

CREDAL_CLAUDE_MODELS = [
    'claude-3-haiku-20240307',
    'claude-3-5-haiku-latest',
    'claude-3-opus-20240229',
    'claude-3-5-sonnet-20240620',
    'claude-3-5-sonnet-latest',
    'claude-3-7-sonnet-20250219',
    'claude-3-7-sonnet-latest',
    'claude-4-sonnet-20250514',
    'claude-4-opus-20250514',
    'claude-opus-4-1-20250805',
    'claude-sonnet-4-5-20250929',
]

# Bedrock Claude model aliases mapped to their system profiles
BEDROCK_CLAUDE_MODEL_ALIASES = {
    'claude-3-5-haiku': 'us.anthropic.claude-3-5-haiku-20241022-v1:0',
    'claude-4-5-haiku': 'us.anthropic.claude-haiku-4-5-20251001-v1:0',
    'claude-3-5-sonnet-v2': 'us.anthropic.claude-3-5-sonnet-20241022-v2:0',
    'claude-3-7-sonnet': 'us.anthropic.claude-3-7-sonnet-20250219-v1:0',
    'claude-4-sonnet': 'us.anthropic.claude-sonnet-4-20250514-v1:0',
    'claude-4-5-sonnet': 'us.anthropic.claude-sonnet-4-5-20250929-v1:0',
    'claude-3-opus': 'us.anthropic.claude-3-opus-20240229-v1:0',
    'claude-4-opus': 'us.anthropic.claude-opus-4-20250514-v1:0',
    'claude-4-1-opus': 'us.anthropic.claude-opus-4-1-20250805-v1:0',
}

# Both aliases and full IDs are valid for registry lookup
BEDROCK_CLAUDE_MODELS = list(BEDROCK_CLAUDE_MODEL_ALIASES.keys()) + list(BEDROCK_CLAUDE_MODEL_ALIASES.values())


def _anthropic_format_request(text: str, stop: Optional[List[str]] = None, **kwargs) -> Dict:
    try:
        if 'max_tokens' not in kwargs:
            kwargs['max_tokens'] = MAX_CLAUDE_OUTPUT_TOKENS

        request = {
            'messages': [{'role': 'user', 'content': text}],
            **kwargs,
        }

        if stop:
            request['stop_sequences'] = stop

    except Exception as ex:
        raise RequestFormattingError(f'Failed to format request: {ex}') from ex

    return request


def _anthropic_format_response(response: Dict) -> str:
    try:
        return str(response['content'][0]['text'])

    except Exception as ex:
        raise ResponseFormattingError(f'Failed to format response: {ex}') from ex


@LLMRegistry.register(CREDAL_CLAUDE_MODELS)
class AnthropicCredal(GatewayLLMWrapper):
    vendor: str = 'credal/anthropic'
    endpoint: str = 'v1/messages'

    def _format_request(
        self,
        text: str,
        stop: Optional[List[str]] = None,
        **kwargs,
    ) -> Dict:
        return _anthropic_format_request(text, stop, **kwargs)

    def _format_response(self, response: Dict) -> str:
        return _anthropic_format_response(response)


@LLMRegistry.register(BEDROCK_CLAUDE_MODELS)
class AnthropicBedrock(GatewayLLMWrapper):
    vendor: str = 'bedrock'
    endpoint: str = 'invoke-model'

    def _format_request(
        self,
        text: str,
        stop: Optional[List[str]] = None,
        **kwargs,
    ) -> Dict:
        if 'anthropic_version' not in kwargs:
            kwargs['anthropic_version'] = 'bedrock-2023-05-31'

        return _anthropic_format_request(text, stop, **kwargs)

    def _format_response(self, response: Dict) -> str:
        return _anthropic_format_response(response)
