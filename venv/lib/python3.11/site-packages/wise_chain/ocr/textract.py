from __future__ import annotations

import base64
from pathlib import Path
from typing import ClassVar, Optional

from pydantic import BaseModel, ConfigDict, model_validator
from typing_extensions import Self

from wise_chain.auth.authorizer import AuthSession, get_authorized_session
from wise_chain.constants import LLM_GATEWAY_DEFAULT_URL, get_gateway_url
from wise_chain.gateway.call_gateway import call_gateway


class OCRFileNotFound(Exception):
    """Raised when the file requested for OCR is not found."""


class Textract(BaseModel):
    """LLM Gateway Textract client."""

    model_config = ConfigDict(arbitrary_types_allowed=True, extra='forbid')

    DETECT_DOCUMENT_TEXT_ENDPOINT: ClassVar[str] = 'api/v1/user/textract/detect-document-text'

    timeout: int = 30
    llm_gateway_url: str = LLM_GATEWAY_DEFAULT_URL
    session: Optional[AuthSession] = None
    ml_prod: bool = False

    @model_validator(mode='after')
    def validate_gateway_url(self) -> Self:
        self.llm_gateway_url = get_gateway_url('user', self.ml_prod)
        return self

    def detect_document_text_from_file(self, document_path: Path | str) -> dict:
        """Detect text in a document stored in a local file.

        Parameters
        ----------
        document_path : Path | str
            Path to the document.

        Returns
        -------
        dict
            Response from the LLM Gateway.

        Raises
        ------
        LLMGatewayError
            If the request to the LLM Gateway fails.
        """
        if not self.session:
            self.session = get_authorized_session('user', self.ml_prod)

        url = f'{self.llm_gateway_url}/{self.DETECT_DOCUMENT_TEXT_ENDPOINT}'

        try:
            with open(document_path, 'rb') as f:
                content = f.read()
        except FileNotFoundError as e:
            raise OCRFileNotFound(f'File {document_path} not found.') from e

        request = {'bytes': base64.b64encode(content).decode('utf-8')}
        return call_gateway(self.session, request, url, self.timeout)
