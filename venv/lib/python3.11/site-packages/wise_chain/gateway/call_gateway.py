from typing import Dict

import requests

from wise_chain.auth.authorizer import AuthSession
from wise_chain.llms.exceptions import LLMGatewayError


def call_gateway_llm(
    session: AuthSession, model_id: str, labels: Dict[str, str], request: Dict, url: str, timeout: int = 30
) -> Dict:
    return call_gateway(
        session=session,
        url=url,
        timeout=timeout,
        request={
            'model_id': model_id,
            'labels': labels,
            'request': request,
        },
    )


def call_gateway(
    session: AuthSession,
    request: dict,
    url: str,
    timeout: int = 30,
) -> Dict:
    try:
        session_ = session.session
        session_.headers.update({'x-envoy-upstream-rq-timeout-ms': str(timeout * 1000)})
        response = session_.post(
            url,
            json=request,
        )
    except requests.exceptions.RequestException as ex:
        raise LLMGatewayError(f'Request to llm-gateway failed: {ex}') from ex

    if not response.ok:
        raise LLMGatewayError(f'Request to llm-gateway failed with status code {response.status_code}: {response.text}')

    return dict(response.json())
